# =============================================================================
# â˜• Kafka Message Broker Management
# =============================================================================
# This file contains targets for Apache Kafka messaging service
# =============================================================================

.PHONY: kafka-start kafka-dev-start kafka-stop kafka-restart kafka-status kafka-create-topic \
        kafka-list-topics kafka-clean kafka-test kafka-send-test-messages kafka-cleanup-topics

# Include common configuration
include makefiles/common_services/Makefile.common

# =============================================================================
# Kafka Service Management
# =============================================================================

# ğŸš€ Start Kafka in KRaft mode (no Zookeeper), with Kafka UI and setup
kafka-start:
	@echo "ğŸš€ Starting Apache Kafka in KRaft mode with UI..."
	$(DOCKER_COMPOSE) --profile kafka up -d
	@echo "â³ Waiting for Kafka stack to fully initialize..."
	@sleep 30
	@echo "âœ… Kafka started successfully!"
	@echo ""
	@echo "ğŸŒ Service Endpoints:"
	@echo "   â€¢ Kafka Broker: localhost:9092"
	@echo "   â€¢ Kafka Controller: localhost:9093"
	@echo "   â€¢ Kafka UI: http://localhost:8080"
	@echo ""
	@echo "ğŸ“‹ Created Topics:"
	@echo "   â€¢ snaplogic-events (3 partitions)"
	@echo "   â€¢ snaplogic-logs (2 partitions)"
	@echo "   â€¢ snaplogic-metrics (1 partition)"

# ğŸš€ Start Kafka for development (without setup container)
kafka-dev-start:
	@echo "ğŸš€ Starting Apache Kafka in development mode..."
	$(DOCKER_COMPOSE) --profile kafka-dev up -d
	@echo "â³ Waiting for Kafka to initialize..."
	@sleep 20
	@echo "âœ… Kafka started in dev mode (no automatic topic creation)."
	@echo "ğŸ’¡ Create topics manually if needed using 'make kafka-create-topic'"

# â›” Stop Kafka and all related services
kafka-stop:
	@echo "â›” Stopping Kafka services..."
	$(DOCKER_COMPOSE) stop kafka kafka-ui kafka-setup 2>/dev/null || true
	@echo "ğŸ—‘ï¸ Removing Kafka containers..."
	$(DOCKER_COMPOSE) rm -f kafka kafka-ui kafka-setup 2>/dev/null || true
	@echo "âœ… Kafka services stopped."

# ğŸ”„ Restart Kafka services
kafka-restart:
	@echo "ğŸ”„ Restarting Kafka services..."
	@$(MAKE) kafka-stop
	@sleep 5
	@$(MAKE) kafka-start
	@echo "âœ… Kafka services restarted successfully!"

# ğŸ” Check Kafka services status
kafka-status:
	@echo "ğŸ” Checking Kafka services status..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@kafka_status=$$(docker inspect -f '{{.State.Status}}' snaplogic-kafka-kraft 2>/dev/null || echo "not found"); \
	ui_status=$$(docker inspect -f '{{.State.Status}}' snaplogic-kafka-ui 2>/dev/null || echo "not found"); \
	if [ "$$kafka_status" = "running" ]; then \
		echo "âœ… Kafka broker (KRaft mode) is running"; \
		echo "   ğŸ“¡ Broker port: 9092"; \
		echo "   ğŸ›ï¸ Controller port: 9093"; \
		echo "ğŸ§ª Testing broker connection..."; \
		docker exec snaplogic-kafka-kraft kafka-broker-api-versions.sh --bootstrap-server localhost:9092 >/dev/null 2>&1 && \
			echo "   âœ… Broker is responding" || \
			echo "   âš ï¸  Broker not yet ready"; \
	else \
		echo "âŒ Kafka broker is not running (status: $$kafka_status)"; \
	fi; \
	if [ "$$ui_status" = "running" ]; then \
		echo "âœ… Kafka UI is running"; \
		echo "   ğŸŒ Web UI: http://localhost:8080"; \
	else \
		echo "âŒ Kafka UI is not running (status: $$ui_status)"; \
	fi; \
	echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
	if [ "$$kafka_status" = "running" ]; then \
		echo "ğŸ“‹ Available topics:"; \
		docker exec snaplogic-kafka-kraft kafka-topics.sh --bootstrap-server localhost:9092 --list 2>/dev/null | sed 's/^/   â€¢ /' || \
			echo "   âš ï¸  Could not list topics"; \
	else \
		echo "ğŸ’¡ Run 'make kafka-start' to start Kafka services"; \
	fi

# ğŸ·ï¸ Create a Kafka topic
# Usage: make kafka-create-topic TOPIC=my-topic PARTITIONS=3
kafka-create-topic:
	@if [ -z "$(TOPIC)" ]; then \
		echo "âŒ Please specify a topic name: make kafka-create-topic TOPIC=my-topic"; \
		exit 1; \
	fi
	@partitions=${PARTITIONS:-1}; \
	echo "ğŸ“ Creating Kafka topic '$(TOPIC)' with $partitions partition(s)..."; \
	docker exec snaplogic-kafka-kraft kafka-topics.sh \
		--bootstrap-server localhost:9092 \
		--create --if-not-exists \
		--topic $(TOPIC) \
		--partitions $partitions \
		--replication-factor 1 && \
	echo "âœ… Topic '$(TOPIC)' created successfully!" || \
	echo "âŒ Failed to create topic '$(TOPIC)'"

# ğŸ“‹ List all Kafka topics
kafka-list-topics:
	@echo "ğŸ“‹ Listing all Kafka topics..."
	@docker exec snaplogic-kafka-kraft kafka-topics.sh \
		--bootstrap-server localhost:9092 --list || \
		echo "âŒ Could not list topics. Is Kafka running?"

# ğŸ§¹ Clean Kafka data (removes all data volumes)
kafka-clean:
	@echo "ğŸ§¹ Cleaning Kafka data and volumes..."
	@$(MAKE) kafka-stop
	@echo "ğŸ—‘ï¸ Removing Kafka volumes..."
	@docker volume rm docker_kafka-kraft-data docker_kafka-kraft-logs 2>/dev/null || true
	@echo "âœ… Kafka cleaned. All data removed."

# ğŸ§ª Test Kafka connectivity and produce/consume messages
kafka-test:
	@echo "ğŸ§ª Testing Kafka setup..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "1ï¸âƒ£ Creating test topic..."
	@docker exec snaplogic-kafka-kraft kafka-topics.sh \
		--bootstrap-server localhost:9092 \
		--create --if-not-exists \
		--topic test-topic \
		--partitions 1 \
		--replication-factor 1 >/dev/null 2>&1 || true
	@echo "2ï¸âƒ£ Producing test message..."
	@echo "Hello Kafka from SnapLogic!" | docker exec -i snaplogic-kafka-kraft \
		kafka-console-producer.sh \
		--bootstrap-server localhost:9092 \
		--topic test-topic
	@echo "3ï¸âƒ£ Consuming test message..."
	@timeout 5 docker exec snaplogic-kafka-kraft \
		kafka-console-consumer.sh \
		--bootstrap-server localhost:9092 \
		--topic test-topic \
		--from-beginning \
		--max-messages 1 2>/dev/null || true
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "âœ… Kafka test completed!"

# ğŸ“¤ Send test messages to Kafka topics
kafka-send-test-messages:
	@echo "ğŸ“¤ Sending test messages to Kafka topics..."
	$(DOCKER_COMPOSE) --profile kafka-test up kafka-test-producer
	@echo "âœ… Test messages sent successfully!"

# ğŸ§¹ Clean up Kafka topics (removes all non-system topics)
kafka-cleanup-topics:
	@echo "ğŸ§¹ Cleaning up Kafka topics..."
	@echo "âš ï¸  This will delete all non-system topics!"
	$(DOCKER_COMPOSE) --profile kafka-cleanup up kafka-cleanup
	@echo "âœ… Kafka topics cleaned up!"
