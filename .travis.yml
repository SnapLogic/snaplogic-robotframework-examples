version: "~> 1.0"

# ===== ENVIRONMENT VARIABLES =====
env:
  global:
    # Build Configuration
    - HMD_HOME=$TRAVIS_BUILD_DIR

# ===== BUILD ENVIRONMENT =====
dist: jammy
group: stable
language: python
python:
  - 3.12

services:
  - docker

# ===== BUILD CONFIGURATION =====
install: skip

# ===== PRE-SETUP =====
before_script:
  - echo "ðŸ” Locating generated Cookiecutter project directory..."
  # Find subdirectory containing travis_scripts (the generated project)
  - export TEMPLATE_DIR=$(find . -maxdepth 2 -type d -name "travis_scripts" -exec dirname {} \; | head -n 1)
  - if [ -z "$TEMPLATE_DIR" ]; then echo "âŒ Could not find generated project directory with travis_scripts"; exit 1; fi
  - 'echo "ðŸ“‚ Using template directory: $TEMPLATE_DIR"'
  - cd "$TEMPLATE_DIR"
  - chmod +x ./travis_scripts/setup_travis_env.sh
  - ./travis_scripts/setup_travis_env.sh

# ===== JOBS =====
jobs:
  include:
    - stage: start-services
      script:
        - echo "ðŸ” Re-detecting generated project directory..."
        - export TEMPLATE_DIR=$(find . -maxdepth 2 -type d -name "travis_scripts" -exec dirname {} \; | head -n 1)
        - if [ -z "$TEMPLATE_DIR" ]; then echo "âŒ Could not find generated project directory with travis_scripts"; exit 1; fi
        - 'echo "ðŸ“‚ Using template directory: $TEMPLATE_DIR"'
        - cd "$TEMPLATE_DIR"

        # Capture commit info for reporting
        - export TRAVIS_COMMIT_AUTHOR_NAME="$(git log -1 --pretty=format:'%an' 2>/dev/null || echo 'CI Build')"
        - export TRAVIS_COMMIT_AUTHOR_EMAIL="$(git log -1 --pretty=format:'%ae')"

        # Stop preinstalled Postgres (avoid port conflicts)
        - sudo service postgresql stop

        # Docker debugging & environment check
        - chmod +x ./travis_scripts/debug_docker_build.sh
        - ./travis_scripts/debug_docker_build.sh

        # Start all required services (DB, MinIO, Kafka, etc.)
        - make start-services

        # Execute Robot Framework tests with tags
        - make robot-run-all-tests TAGS="oracle sqlserver file_mount postgres_s3 sla_pipeline email2 snowflake_demo" PROJECT_SPACE_SETUP=True

        # Upload test results to TestRail
        - make upload-test-results

        # Notify Slack on completion
        - make slack-notify
      name: Build Docs

# ===== NOTIFICATIONS =====
notifications:
  slack:
    rooms:
      - secure: SlF5EB6bNzPqZZQtrPjDwfaBEV3qY9Tk1OzZqeguIDYZv6CFTe0nVrQUzbCHTnEyeaUc2RcfArRQmr5t0cQnjW5XuPy1WbD5igaoDI/jLY8lwnjIdliJvJnK11428+PQ6O0Q6cjyK7fX54dR2TIygHgr6Vx5yu+k8ONk78nWdSqwcpKI8ZzURHc5SUTV/LBAVfXg4gpuC4J0U6CZC+ttuGLkxlEhKVum7e8BELZns+EoJMkvMD/HiV14gsC77j3e0wT9nzGSOS/fxifVTVRiQn+QZbj7FNa9BJWsrQFbWyrZqtC+0xyZMtt8/ev1AVTETvXJtXYkJflYSuNCjEtCBBz9F36QvaTWMjB/chg+FmuOsxbnHm1D+ekRTrZ53Bzd4qikFX6RnBMyjMrFAwArf9mz7/RmVXUofjvPpC+JP3mQH1NItTEF09c5rvVyyzAFzqkBQPY3OSZeUM7UDE75NamB30GaTvqXqjwXQcdsjUWJuMu6TwAqUGuFARb9m/O0+SWWo/lM0IXT2JrK6r9S1JganSK0SHo9SttRkfXQtYlteXxA/Rou5VWO+auHlsiwjPTPjSQvII5rp8qampnI3LuaSH7RcRWwrzX3ktnhS5xG6eyLFD4P9kDP7v9YjLwo/iBzme+DFeTC1EbkhMSjawtDNjB7kooZgp9TkqTzRNA=
    on_success: always
    on_failure: always
