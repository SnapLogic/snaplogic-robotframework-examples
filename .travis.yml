version: "~> 1.0"

# ===== ENVIRONMENT VARIABLES =====
env:
  global:
    # Build Configuration (Keep these as they're Travis-specific)
    - HMD_HOME=$TRAVIS_BUILD_DIR

    # NOTE: All database, service, and messaging configurations
    # are now loaded from env_files/ directory by setup_env.sh
    #
    # Sensitive credentials should be set in Travis CI Settings:
    # - Go to Travis CI > Settings > Environment Variables
    # - Add variables like SNOWFLAKE_PASSWORD, ORACLE_PASSWORD, etc.
    #
    # Default non-sensitive values are in:
    # - env_files/database_accounts/
    # - env_files/messaging_service_accounts/
    # - env_files/mock_service_accounts/
    # - env_files/groundplex/

# ===== BUILD ENVIRONMENT =====
dist: jammy
group: stable
language: python
python:
  - 3.12

services:
  - docker

# ===== BUILD CONFIGURATION =====
install: skip

before_script:
  - "echo \"\U0001F50DEnvironment Variables set up and creating .env file:\""
  - chmod +x ./travis_scripts/setup_travis_env.sh
  - "./travis_scripts/setup_travis_env.sh"

# ===== JOBS =====
jobs:
  include:
    - stage: start-services
      script:
        #  Export Travis environment variables to be used by docker-compose
        - export TRAVIS_COMMIT_AUTHOR_NAME="$(git log -1 --pretty=format:'%an' 2>/dev/null || echo 'CI Build')"
        - export TRAVIS_COMMIT_AUTHOR_EMAIL="$(git log -1 --pretty=format:'%ae')"
        - env | grep TRAVIS
        - sudo service postgresql stop # stop any running postgres services for more info see SLIM-437
        # Run Docker build debugging script
        - chmod +x ./travis_scripts/debug_docker_build.sh
        - ./travis_scripts/debug_docker_build.sh
        # Start services after debugging
        - make snaplogic-start-services
        - make robot-run-all-tests TAGS="oracle sqlserver file_mount postgres_s3 sla snowflake_demo email2" PROJECT_SPACE_SETUP=True
        - make upload-test-results
        - make slack-notify

      name: Build Docs

# ===== NOTIFICATIONS =====
notifications:
  slack:
    rooms:
      - secure: SlF5EB6bNzPqZZQtrPjDwfaBEV3qY9Tk1OzZqeguIDYZv6CFTe0nVrQUzbCHTnEyeaUc2RcfArRQmr5t0cQnjW5XuPy1WbD5igaoDI/jLY8lwnjIdliJvJnK11428+PQ6O0Q6cjyK7fX54dR2TIygHgr6Vx5yu+k8ONk78nWdSqwcpKI8ZzURHc5SUTV/LBAVfXg4gpuC4J0U6CZC+ttuGLkxlEhKVum7e8BELZns+EoJMkvMD/HiV14gsC77j3e0wT9nzGSOS/fxifVTVRiQn+QZbj7FNa9BJWsrQFbWyrZqtC+0xyZMtt8/ev1AVTETvXJtXYkJflYSuNCjEtCBBz9F36QvaTWMjB/chg+FmuOsxbnHm1D+ekRTrZ53Bzd4qikFX6RnBMyjMrFAwArf9mz7/RmVXUofjvPpC+JP3mQH1NItTEF09c5rvVyyzAFzqkBQPY3OSZeUM7UDE75NamB30GaTvqXqjwXQcdsjUWJuMu6TwAqUGuFARb9m/O0+SWWo/lM0IXT2JrK6r9S1JganSK0SHo9SttRkfXQtYlteXxA/Rou5VWO+auHlsiwjPTPjSQvII5rp8qampnI3LuaSH7RcRWwrzX3ktnhS5xG6eyLFD4P9kDP7v9YjLwo/iBzme+DFeTC1EbkhMSjawtDNjB7kooZgp9TkqTzRNA=
    on_success: always
    on_failure: always
