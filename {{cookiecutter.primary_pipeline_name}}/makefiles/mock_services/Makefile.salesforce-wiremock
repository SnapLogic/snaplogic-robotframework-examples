# =============================================================================
# Salesforce WireMock + JSON Server Management
# =============================================================================
#
# WireMock-based Salesforce mock with static response mappings.
# Uses 2 containers: WireMock (API mock) + JSON Server (persistent CRUD).
#
# Container:    salesforce-api-mock (WireMock) + salesforce-json-mock (JSON Server)
# HTTP port:    8089
# HTTPS port:   8443
# JSON Server:  8082
# Network:      snaplogicnet
# Compose file: docker/salesforce/docker-compose.salesforce-mock.yml
#
# NOTE: Shares the same container name and ports as Custom Server.
#       They are MUTUALLY EXCLUSIVE â€” only one can run at a time.
#       The start target automatically stops the other backend first.
#
# Quick Reference:
#   make salesforce-mock-start       Start WireMock + JSON Server
#   make salesforce-mock-stop        Stop all services
#   make salesforce-mock-restart     Restart all services
#   make salesforce-mock-status      Check service status
#   make salesforce-mock-test        Test endpoints
#   make salesforce-mock-clean       Clean data and volumes
#   make salesforce-mock-logs        View logs
#   make start-jsonserver            Start only JSON Server
#   make stop-jsonserver             Stop only JSON Server
# =============================================================================

.PHONY: salesforce-mock-start salesforce-mock-stop salesforce-mock-status \
        salesforce-mock-restart salesforce-mock-clean salesforce-mock-test \
        salesforce-mock-logs \
        start-jsonserver stop-jsonserver

# Docker Compose file for WireMock
WIREMOCK_COMPOSE := docker compose -f docker/salesforce/docker-compose.salesforce-mock.yml

# =============================================================================
# Service Management
# =============================================================================

## Start WireMock + JSON Server (stops Custom Server if running)
salesforce-mock-start:
	@echo "ðŸš€ Starting Salesforce WireMock + JSON Server..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@# Stop Custom Server if running (same container name / ports)
	@if docker inspect -f "{{.State.Status}}" salesforce-api-mock >/dev/null 2>&1; then \
		echo "âš ï¸  Stopping existing salesforce-api-mock container first..."; \
		docker stop salesforce-api-mock >/dev/null 2>&1 || true; \
		docker rm -f salesforce-api-mock >/dev/null 2>&1 || true; \
		echo ""; \
	fi
	$(WIREMOCK_COMPOSE) --profile salesforce-dev up -d salesforce-mock salesforce-json-server
	@echo "â³ Waiting for services to initialize..."
	@sleep 5
	@echo "âœ… Salesforce mock services started!"
	@echo ""
	@echo "ðŸŒ Available endpoints:"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "ðŸ“¡ WireMock API Mock:"
	@echo "   â€¢ Base URL: http://localhost:8089 (will show 403 - this is normal!)"
	@echo "   â€¢ OAuth Token: POST http://localhost:8089/services/oauth2/token"
	@echo "   â€¢ Query API: GET http://localhost:8089/services/data/v59.0/query"
	@echo "   â€¢ CRUD Operations: http://localhost:8089/services/data/v59.0/sobjects/Account"
	@echo "   â€¢ Admin Console: http://localhost:8089/__admin/"
	@echo "   â€¢ View Mappings: http://localhost:8089/__admin/mappings"
	@echo ""
	@echo "ðŸ’¾ JSON Server (Persistent Storage):"
	@echo "   â€¢ Base URL: http://localhost:8082"
	@echo "   â€¢ Accounts: http://localhost:8082/accounts"
	@echo "   â€¢ Contacts: http://localhost:8082/contacts"
	@echo "   â€¢ Opportunities: http://localhost:8082/opportunities"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "ðŸ”§ Configure SnapLogic Salesforce Account:"
	@echo "   â€¢ Login URL: http://localhost:8089"
	@echo "   â€¢ Username: snap-qa@snaplogic.com (or any value)"
	@echo "   â€¢ Password: any value"
	@echo ""
	@echo "ðŸ§ª Test the service:"
	@echo "   curl -X POST http://localhost:8089/services/oauth2/token -d 'grant_type=password'"

## Stop all WireMock + JSON Server services
salesforce-mock-stop:
	@echo "â›” Stopping Salesforce WireMock + JSON Server..."
	@docker stop salesforce-api-mock 2>/dev/null || true
	@docker stop salesforce-json-mock 2>/dev/null || true
	@echo "ðŸ—‘ï¸ Removing containers..."
	@docker rm -f salesforce-api-mock 2>/dev/null || true
	@docker rm -f salesforce-json-mock 2>/dev/null || true
	@echo "ðŸ§¹ Cleaning up Salesforce mock volumes..."
	@docker volume rm $$(docker volume ls -q | grep salesforce) 2>/dev/null || true
	@echo "âœ… Salesforce mock stopped and cleaned up."

## Restart WireMock + JSON Server
salesforce-mock-restart:
	@echo "ðŸ”„ Restarting Salesforce WireMock + JSON Server..."
	@$(MAKE) salesforce-mock-stop
	@sleep 2
	@$(MAKE) salesforce-mock-start

## Check WireMock + JSON Server status
salesforce-mock-status:
	@bash -c '\
		echo "ðŸ” Checking Salesforce WireMock + JSON Server status..."; \
		echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
		wiremock_status=$$(docker inspect -f "{{.State.Status}}" salesforce-api-mock 2>/dev/null || echo "not found"); \
		json_server_status=$$(docker inspect -f "{{.State.Status}}" salesforce-json-mock 2>/dev/null || echo "not found"); \
		if [ "$$wiremock_status" = "running" ]; then \
			echo "âœ… WireMock container is running"; \
			echo "   Container: salesforce-api-mock"; \
			echo "   Port: 8089"; \
		else \
			echo "âŒ WireMock container is not running (status: $$wiremock_status)"; \
		fi; \
		if [ "$$json_server_status" = "running" ]; then \
			echo "âœ… JSON Server container is running"; \
			echo "   Container: salesforce-json-mock"; \
			echo "   Port: 8082"; \
		else \
			echo "âŒ JSON Server container is not running (status: $$json_server_status)"; \
		fi; \
		echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
		if [ "$$wiremock_status" = "running" ] && [ "$$json_server_status" = "running" ]; then \
			echo "ðŸŒ Available endpoints:"; \
			echo "   â€¢ Base URL: http://localhost:8089"; \
			echo "   â€¢ Admin Console: http://localhost:8089/__admin/"; \
			echo "   â€¢ Request Journal: http://localhost:8089/__admin/requests"; \
			echo "   â€¢ JSON Server: http://localhost:8082"; \
			echo ""; \
			echo "ðŸ§ª Testing service health..."; \
			if curl -s -f http://localhost:8089/__admin/health >/dev/null 2>&1; then \
				echo "   âœ… WireMock health check passed"; \
			else \
				echo "   âš ï¸  WireMock health check failed"; \
			fi; \
			if curl -s -f -X POST http://localhost:8089/services/oauth2/token -d "grant_type=password" >/dev/null 2>&1; then \
				echo "   âœ… OAuth endpoint is accessible"; \
			else \
				echo "   âš ï¸  OAuth endpoint not responding"; \
			fi; \
			if curl -s -f http://localhost:8082/ >/dev/null 2>&1; then \
				echo "   âœ… JSON Server is accessible"; \
			else \
				echo "   âš ï¸  JSON Server not responding"; \
			fi; \
		elif [ "$$wiremock_status" = "running" ] || [ "$$json_server_status" = "running" ]; then \
			echo "âš ï¸  WARNING: Only partial services are running"; \
			echo "ðŸ’¡ Run '\''make salesforce-mock-restart'\'' to restart all services"; \
		else \
			echo "ðŸ’¡ Run '\''make salesforce-mock-start'\'' to start the mock services"; \
		fi'

# =============================================================================
# Testing
# =============================================================================

## Test WireMock mock endpoints
salesforce-mock-test:
	@echo "ðŸ§ª Testing Salesforce WireMock mock endpoints..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "1ï¸âƒ£ Testing OAuth endpoint..."
	@curl -s -X POST http://localhost:8089/services/oauth2/token \
		-d "grant_type=password&username=test@test.com&password=test" \
		| python3 -m json.tool 2>/dev/null || echo "   âš ï¸  OAuth endpoint not responding"
	@echo ""
	@echo "2ï¸âƒ£ Testing JSON Server accounts endpoint..."
	@curl -s http://localhost:8082/accounts | python3 -m json.tool 2>/dev/null || echo "   âš ï¸  JSON Server not responding"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "âœ… Salesforce WireMock tests completed!"

## Clean WireMock data and restart
salesforce-mock-clean:
	@echo "ðŸ§¹ Cleaning Salesforce mock data..."
	@$(MAKE) salesforce-mock-stop
	@echo "ðŸ—‘ï¸ Removing all Salesforce mock volumes and data..."
	@docker volume rm $$(docker volume ls -q | grep salesforce) 2>/dev/null || true
	@rm -rf ./docker/scripts/salesforce/json-db/*.json 2>/dev/null || true
	@echo "âœ… Salesforce mock data cleaned!"

# =============================================================================
# Logs
# =============================================================================

## View WireMock + JSON Server logs
salesforce-mock-logs:
	@echo "ðŸ“‹ Salesforce WireMock + JSON Server Logs"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "ðŸ“¡ WireMock Logs:"
	@docker logs salesforce-api-mock --tail=20 2>/dev/null || echo "   No WireMock logs available"
	@echo ""
	@echo "ðŸ’¾ JSON Server Logs:"
	@docker logs salesforce-json-mock --tail=20 2>/dev/null || echo "   No JSON Server logs available"

# =============================================================================
# JSON Server (standalone)
# =============================================================================

## Start only JSON Server for persistent CRUD operations
start-jsonserver:
	@echo "ðŸš€ Starting Salesforce JSON Server..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	$(WIREMOCK_COMPOSE) up -d salesforce-json-server
	@echo "â³ Waiting for JSON Server to initialize..."
	@sleep 3
	@echo "âœ… JSON Server started!"
	@echo ""
	@echo "ðŸŒ Available endpoints:"
	@echo "   â€¢ From host machine: http://localhost:8082"
	@echo "   â€¢ From Docker containers: http://salesforce-json-mock"
	@echo "   â€¢ Database file: ./docker/scripts/salesforce/json-db/salesforce-db.json"
	@echo ""
	@echo "ðŸ§ª Test from your host machine:"
	@echo "   curl http://localhost:8082/accounts"
	@echo "   curl http://localhost:8082/contacts"
	@echo "   curl http://localhost:8082/opportunities"
	@echo ""
	@echo "ðŸ³ Test from Docker container (e.g., Groundplex):"
	@echo "   docker exec snaplogic-groundplex curl http://salesforce-json-mock/accounts"
	@echo ""
	@echo "ðŸ”§ SnapLogic REST Snap configuration:"
	@echo "   Service URL: http://salesforce-json-mock"
	@echo "   Resource Path: /accounts"

## Stop only JSON Server
stop-jsonserver:
	@echo "â›” Stopping Salesforce JSON Server..."
	@docker stop salesforce-json-mock 2>/dev/null || true
	@echo "ðŸ—‘ï¸ Removing JSON Server container..."
	@docker rm -f salesforce-json-mock 2>/dev/null || true
	@echo "âœ… JSON Server stopped and cleaned up."
