# =============================================================================
# â˜ï¸ MinIO S3-Compatible Storage Emulator
# =============================================================================
# This file contains targets for MinIO S3-compatible storage mock service
# =============================================================================

.PHONY: start-s3-emulator stop-s3-emulator run-s3-demo s3-status s3-restart s3-clean

# Include common configuration
include makefiles/common_services/Makefile.common

# =============================================================================
# MinIO S3 Service Management
# =============================================================================

# ğŸš€ Start MinIO S3 emulator
start-s3-emulator:
	@echo "ğŸš€ Starting MinIO S3 emulator..."
	$(DOCKER_COMPOSE) --profile minio-dev up -d minio
	@echo "â³ Waiting for MinIO to initialize..."
	@sleep 5
	@echo "âœ… MinIO S3 emulator started!"
	@echo ""
	@echo "ğŸŒ Service endpoints:"
	@echo "   â€¢ API Endpoint: http://localhost:9010"
	@echo "   â€¢ Console UI: http://localhost:9011"
	@echo "   â€¢ Access Key: minioadmin"
	@echo "   â€¢ Secret Key: minioadmin"
	@echo ""
	@echo "ğŸ”§ SnapLogic S3 Snap configuration:"
	@echo "   â€¢ Endpoint URL: http://localhost:9010"
	@echo "   â€¢ Access Key ID: minioadmin"
	@echo "   â€¢ Secret Access Key: minioadmin"
	@echo "   â€¢ Region: us-east-1"
	@echo "   â€¢ Path Style Access: true"

# â›” Stop MinIO S3 emulator
stop-s3-emulator:
	@echo "â›” Stopping MinIO S3 emulator..."
	$(DOCKER_COMPOSE) stop minio
	@echo "ğŸ—‘ï¸ Removing MinIO container..."
	$(DOCKER_COMPOSE) rm -f minio 2>/dev/null || true
	@echo "âœ… MinIO S3 emulator stopped."

# ğŸ”„ Restart MinIO S3 emulator
s3-restart:
	@echo "ğŸ”„ Restarting MinIO S3 emulator..."
	@$(MAKE) stop-s3-emulator
	@sleep 2
	@$(MAKE) start-s3-emulator
	@echo "âœ… MinIO S3 emulator restarted successfully!"

# ğŸ” Check MinIO S3 emulator status
s3-status:
	@echo "ğŸ” Checking MinIO S3 emulator status..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@container_status=$$(docker inspect -f '{{.State.Status}}' minio-s3-emulator 2>/dev/null || echo "not found"); \
	if [ "$$container_status" = "running" ]; then \
		echo "âœ… MinIO container is running"; \
		echo "   Container: minio-s3-emulator"; \
		echo "   API Port: 9010"; \
		echo "   Console Port: 9011"; \
		echo ""; \
		echo "ğŸ§ª Testing service health..."; \
		if curl -s -f http://localhost:9010/minio/health/live >/dev/null 2>&1; then \
			echo "   âœ… MinIO API is healthy"; \
		else \
			echo "   âš ï¸  MinIO API not responding"; \
		fi; \
		if curl -s -f http://localhost:9011/ >/dev/null 2>&1; then \
			echo "   âœ… MinIO Console is accessible"; \
		else \
			echo "   âš ï¸  MinIO Console not responding"; \
		fi; \
		echo ""; \
		echo "ğŸ“Š Container resource usage:"; \
		docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" minio-s3-emulator 2>/dev/null || true; \
	else \
		echo "âŒ MinIO container is not running (status: $$container_status)"; \
		echo "ğŸ’¡ Run 'make start-s3-emulator' to start MinIO"; \
	fi

# ğŸ§¹ Clean MinIO data and volumes
s3-clean:
	@echo "ğŸ§¹ Cleaning MinIO data and volumes..."
	@$(MAKE) stop-s3-emulator
	@echo "ğŸ—‘ï¸ Removing MinIO volumes..."
	@docker volume rm $$(docker volume ls -q | grep minio) 2>/dev/null || true
	@echo "âœ… MinIO cleaned. All data removed."

# ğŸ§ª Run S3 demo script
run-s3-demo:
	@echo "ğŸ§ª Running MinIO S3 demo script..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@if [ ! -f "test/suite/test_data/python_helper_files/minio_demo.py" ]; then \
		echo "âŒ Demo script not found: test/suite/test_data/python_helper_files/minio_demo.py"; \
		echo "ğŸ’¡ Creating a sample demo script..."; \
		echo "   Please implement your S3 operations in the demo script."; \
		exit 1; \
	fi
	@echo "ğŸ“¦ Creating demo bucket and uploading test data..."
	python3 test/suite/test_data/python_helper_files/minio_demo.py \
		--endpoint http://localhost:9010 \
		--access-key minioadmin \
		--secret-key minioadmin \
		--bucket demo-bucket2
	@echo "âœ… S3 demo completed successfully!"
	@echo ""
	@echo "ğŸŒ View your data in MinIO Console:"
	@echo "   http://localhost:9011"
	@echo "   Login: minioadmin / minioadmin"
