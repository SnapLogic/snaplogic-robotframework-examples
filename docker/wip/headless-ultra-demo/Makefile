# Makefile for Headless Ultra Demo - Bitnami Kafka
# Uses Bitnami images for consistency with main Kafka setup

KAFKA_CONTAINER = snaplogic-kafka-kraft
COMPOSE_FILE = docker-compose.headless-ultra-bitnami.yml

.PHONY: help start stop status producer monitor logs clean partitions test-consumer health send-test

help:
	@echo "ğŸš€ Headless Ultra Demo Commands (Bitnami)"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "  make start         - Start Ultra instances"
	@echo "  make producer      - Start message producer"
	@echo "  make monitor       - Open Kafka UI (port 8081)"
	@echo "  make status        - Check consumer group status"
	@echo "  make partitions    - Show partition assignments"
	@echo "  make logs          - View all instance logs"
	@echo "  make test-consumer - Test single consumer"
	@echo "  make send-test     - Send test messages manually"
	@echo "  make health        - Health check"
	@echo "  make stop          - Stop all containers"
	@echo "  make clean         - Stop and remove everything"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Start the headless ultra demo
start:
	@echo "ğŸš€ Starting Headless Ultra Demo (Bitnami)..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "ğŸ“ Prerequisites: Kafka must be running"
	@echo ""
	@echo "ğŸ”§ Making scripts executable..."
	@chmod +x *.sh 2>/dev/null || true
	@docker-compose -f $(COMPOSE_FILE) up -d
	@echo ""
	@echo "â³ Waiting for instances to start..."
	@sleep 10
	@echo "âœ… Ultra instances are running!"
	@echo ""
	@echo "ğŸ“Š Active Consumer Groups:"
	@docker exec $(KAFKA_CONTAINER) kafka-consumer-groups.sh \
		--bootstrap-server localhost:9092 --list 2>/dev/null | grep snaplogic || echo "No groups active yet"
	@echo ""
	@echo "ğŸ’¡ Next steps:"
	@echo "   1. Run 'make producer' to start sending messages"
	@echo "   2. Run 'make monitor' to view Kafka UI"
	@echo "   3. Run 'make logs' to see instances processing"

# Start the producer
producer:
	@echo "ğŸ“¤ Starting message producer..."
	@docker-compose -f $(COMPOSE_FILE) --profile producer up -d kafka-producer-headless
	@echo "âœ… Producer started!"
	@echo "ğŸ“Š Check logs with: docker logs -f kafka-producer-headless"

# Start monitoring UI
monitor:
	@echo "ğŸ–¥ï¸  Starting Kafka UI..."
	@docker-compose -f $(COMPOSE_FILE) --profile monitoring up -d kafka-ui-headless
	@echo "âœ… Kafka UI available at: http://localhost:8081"
	@echo "   View consumer groups and partition assignments"
	@sleep 2
	@command -v open >/dev/null 2>&1 && open http://localhost:8081 || echo ""

# Check consumer group status
status:
	@echo "ğŸ“Š Consumer Group Status"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "ğŸ“‹ All Consumer Groups:"
	@docker exec $(KAFKA_CONTAINER) kafka-consumer-groups.sh \
		--bootstrap-server localhost:9092 --list 2>/dev/null || echo "No groups found"
	@echo ""
	@echo "ğŸ”µ Group A Details (Node 1 - Instances 1 & 2):"
	@docker exec $(KAFKA_CONTAINER) kafka-consumer-groups.sh \
		--bootstrap-server localhost:9092 \
		--describe --group snaplogic-group-a 2>/dev/null || echo "Group not active yet"
	@echo ""
	@echo "ğŸŸ¢ Group B Details (Node 2 - Instances 3 & 4):"
	@docker exec $(KAFKA_CONTAINER) kafka-consumer-groups.sh \
		--bootstrap-server localhost:9092 \
		--describe --group snaplogic-group-b 2>/dev/null || echo "Group not active yet"
	@echo ""
	@echo "ğŸ“¦ Container Status:"
	@docker ps --format "table {{.Names}}\t{{.Status}}\t{{.State}}" | grep -E "(snaplex-instance|NAMES)" || true

# Show partition assignments
partitions:
	@echo "ğŸ“Š Partition Assignments for ultra-events topic"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@docker exec $(KAFKA_CONTAINER) kafka-topics.sh \
		--bootstrap-server localhost:9092 \
		--describe --topic ultra-events 2>/dev/null || echo "Topic not found. Run 'make start' first."

# Test a single consumer interactively
test-consumer:
	@echo "ğŸ§ª Starting test consumer for ultra-events topic..."
	@echo "   Press Ctrl+C to stop"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@docker exec -it $(KAFKA_CONTAINER) kafka-console-consumer.sh \
		--bootstrap-server localhost:9092 \
		--topic ultra-events \
		--group test-consumer-group \
		--from-beginning

# View logs from all instances
logs:
	@echo "ğŸ“œ Viewing logs from all Ultra instances..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@docker-compose -f $(COMPOSE_FILE) logs -f --tail=20

# View logs for specific instance
logs-instance:
	@echo "Select instance (1-4):"
	@read INSTANCE && docker logs -f snaplex-ultra-instance-$$INSTANCE

# Stop all containers
stop:
	@echo "â›” Stopping Headless Ultra Demo..."
	@docker-compose -f $(COMPOSE_FILE) down
	@echo "âœ… All instances stopped"

# Clean up everything
clean:
	@echo "ğŸ§¹ Cleaning up Headless Ultra Demo..."
	@docker-compose -f $(COMPOSE_FILE) down -v
	@docker rm -f kafka-producer-headless kafka-setup-headless 2>/dev/null || true
	@echo "âœ… Cleanup complete"

# Send test messages manually
send-test:
	@echo "ğŸ“¨ Sending test messages to ultra-events..."
	@for i in 1 2 3 4 5; do \
		echo "{\"id\": $$i, \"message\": \"Test message $$i\", \"timestamp\": \"$$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" | \
		docker exec -i $(KAFKA_CONTAINER) kafka-console-producer.sh \
			--bootstrap-server localhost:9092 \
			--topic ultra-events; \
	done
	@echo "âœ… Sent 5 test messages"

# Health check
health:
	@echo "ğŸ¥ Health Check"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "Kafka Broker:"
	@docker exec $(KAFKA_CONTAINER) kafka-broker-api-versions.sh \
		--bootstrap-server localhost:9092 >/dev/null 2>&1 \
		&& echo "  âœ… Kafka is healthy" || echo "  âŒ Kafka is not responding"
	@echo ""
	@echo "Consumer Instances:"
	@for i in 1 2 3 4; do \
		if docker ps | grep -q snaplex-ultra-instance-$$i; then \
			echo "  âœ… Instance $$i is running"; \
		else \
			echo "  âŒ Instance $$i is not running"; \
		fi \
	done
	@echo ""
	@echo "Topics:"
	@docker exec $(KAFKA_CONTAINER) kafka-topics.sh \
		--bootstrap-server localhost:9092 --list 2>/dev/null | grep -E "ultra-events|order-events" | \
		while read topic; do echo "  âœ… $$topic exists"; done || echo "  âŒ No topics found"

# Quick info about the setup
info:
	@echo "ğŸ“‹ Headless Ultra Demo Info"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "Image: bitnami/kafka:3.7"
	@echo "Consumer Groups: snaplogic-group-a, snaplogic-group-b"
	@echo "Instances: 4 (2 per node)"
	@echo "Topic: ultra-events (4 partitions)"
	@echo "Kafka UI: http://localhost:8081"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

.DEFAULT_GOAL := help
