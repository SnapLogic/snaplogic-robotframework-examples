# =============================================================================
# Message Queue & Streaming Services Management
# =============================================================================
# This file contains targets for Kafka, ActiveMQ, and other messaging services
# =============================================================================

.PHONY: kafka-start kafka-dev-start kafka-stop kafka-restart kafka-status kafka-create-topic \
        kafka-list-topics kafka-clean kafka-test kafka-send-test-messages kafka-cleanup-topics \
        activemq-start activemq-stop activemq-status activemq-setup run-jms-demo

# Include common configuration
include makefiles/Makefile.common

# =============================================================================
# â˜• Kafka Message Broker Management
# =============================================================================

# ğŸš€ Start Kafka in KRaft mode (no Zookeeper), with Kafka UI and setup
kafka-start:
	@echo "ğŸš€ Starting Apache Kafka in KRaft mode with UI..."
	$(DOCKER_COMPOSE) --profile kafka up -d
	@echo "â³ Waiting for Kafka stack to fully initialize..."
	@sleep 30
	@echo "âœ… Kafka started successfully!"
	@echo ""
	@echo "ğŸŒ Service Endpoints:"
	@echo "   â€¢ Kafka Broker: localhost:9092"
	@echo "   â€¢ Kafka Controller: localhost:9093"
	@echo "   â€¢ Kafka UI: http://localhost:8080"
	@echo ""
	@echo "ğŸ“‹ Created Topics:"
	@echo "   â€¢ snaplogic-events (3 partitions)"
	@echo "   â€¢ snaplogic-logs (2 partitions)"
	@echo "   â€¢ snaplogic-metrics (1 partition)"

# ğŸš€ Start Kafka for development (without setup container)
kafka-dev-start:
	@echo "ğŸš€ Starting Apache Kafka in development mode..."
	$(DOCKER_COMPOSE) --profile kafka-dev up -d
	@echo "â³ Waiting for Kafka to initialize..."
	@sleep 20
	@echo "âœ… Kafka started in dev mode (no automatic topic creation)."
	@echo "ğŸ’¡ Create topics manually if needed using 'make kafka-create-topic'"

# â›” Stop Kafka and all related services
kafka-stop:
	@echo "â›” Stopping Kafka services..."
	$(DOCKER_COMPOSE) stop kafka kafka-ui kafka-setup 2>/dev/null || true
	@echo "ğŸ—‘ï¸ Removing Kafka containers..."
	$(DOCKER_COMPOSE) rm -f kafka kafka-ui kafka-setup 2>/dev/null || true
	@echo "âœ… Kafka services stopped."

# ğŸ”„ Restart Kafka services
kafka-restart:
	@echo "ğŸ”„ Restarting Kafka services..."
	@$(MAKE) kafka-stop
	@sleep 5
	@$(MAKE) kafka-start
	@echo "âœ… Kafka services restarted successfully!"

# ğŸ” Check Kafka services status
kafka-status:
	@echo "ğŸ” Checking Kafka services status..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@kafka_status=$$(docker inspect -f '{{.State.Status}}' snaplogic-kafka-kraft 2>/dev/null || echo "not found"); \
	ui_status=$$(docker inspect -f '{{.State.Status}}' snaplogic-kafka-ui 2>/dev/null || echo "not found"); \
	if [ "$$kafka_status" = "running" ]; then \
		echo "âœ… Kafka broker (KRaft mode) is running"; \
		echo "   ğŸ“¡ Broker port: 9092"; \
		echo "   ğŸ›ï¸ Controller port: 9093"; \
		echo "ğŸ§ª Testing broker connection..."; \
		docker exec snaplogic-kafka-kraft kafka-broker-api-versions.sh --bootstrap-server localhost:9092 >/dev/null 2>&1 && \
			echo "   âœ… Broker is responding" || \
			echo "   âš ï¸  Broker not yet ready"; \
	else \
		echo "âŒ Kafka broker is not running (status: $$kafka_status)"; \
	fi; \
	if [ "$$ui_status" = "running" ]; then \
		echo "âœ… Kafka UI is running"; \
		echo "   ğŸŒ Web UI: http://localhost:8080"; \
	else \
		echo "âŒ Kafka UI is not running (status: $$ui_status)"; \
	fi; \
	echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
	if [ "$$kafka_status" = "running" ]; then \
		echo "ğŸ“‹ Available topics:"; \
		docker exec snaplogic-kafka-kraft kafka-topics.sh --bootstrap-server localhost:9092 --list 2>/dev/null | sed 's/^/   â€¢ /' || \
			echo "   âš ï¸  Could not list topics"; \
	else \
		echo "ğŸ’¡ Run 'make kafka-start' to start Kafka services"; \
	fi

# ğŸ·ï¸ Create a Kafka topic
# Usage: make kafka-create-topic TOPIC=my-topic PARTITIONS=3
kafka-create-topic:
	@if [ -z "$(TOPIC)" ]; then \
		echo "âŒ Please specify a topic name: make kafka-create-topic TOPIC=my-topic"; \
		exit 1; \
	fi
	@partitions=${PARTITIONS:-1}; \
	echo "ğŸ“ Creating Kafka topic '$(TOPIC)' with $partitions partition(s)..."; \
	docker exec snaplogic-kafka-kraft kafka-topics.sh \
		--bootstrap-server localhost:9092 \
		--create --if-not-exists \
		--topic $(TOPIC) \
		--partitions $partitions \
		--replication-factor 1 && \
	echo "âœ… Topic '$(TOPIC)' created successfully!" || \
	echo "âŒ Failed to create topic '$(TOPIC)'"

# ğŸ“‹ List all Kafka topics
kafka-list-topics:
	@echo "ğŸ“‹ Listing all Kafka topics..."
	@docker exec snaplogic-kafka-kraft kafka-topics.sh \
		--bootstrap-server localhost:9092 --list || \
		echo "âŒ Could not list topics. Is Kafka running?"

# ğŸ§¹ Clean Kafka data (removes all data volumes)
kafka-clean:
	@echo "ğŸ§¹ Cleaning Kafka data and volumes..."
	@$(MAKE) kafka-stop
	@echo "ğŸ—‘ï¸ Removing Kafka volumes..."
	@docker volume rm docker_kafka-kraft-data docker_kafka-kraft-logs 2>/dev/null || true
	@echo "âœ… Kafka cleaned. All data removed."

# ğŸ§ª Test Kafka connectivity and produce/consume messages
kafka-test:
	@echo "ğŸ§ª Testing Kafka setup..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "1ï¸âƒ£ Creating test topic..."
	@docker exec snaplogic-kafka-kraft kafka-topics.sh \
		--bootstrap-server localhost:9092 \
		--create --if-not-exists \
		--topic test-topic \
		--partitions 1 \
		--replication-factor 1 >/dev/null 2>&1 || true
	@echo "2ï¸âƒ£ Producing test message..."
	@echo "Hello Kafka from SnapLogic!" | docker exec -i snaplogic-kafka-kraft \
		kafka-console-producer.sh \
		--bootstrap-server localhost:9092 \
		--topic test-topic
	@echo "3ï¸âƒ£ Consuming test message..."
	@timeout 5 docker exec snaplogic-kafka-kraft \
		kafka-console-consumer.sh \
		--bootstrap-server localhost:9092 \
		--topic test-topic \
		--from-beginning \
		--max-messages 1 2>/dev/null || true
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "âœ… Kafka test completed!"

# ğŸ“¤ Send test messages to Kafka topics
kafka-send-test-messages:
	@echo "ğŸ“¤ Sending test messages to Kafka topics..."
	$(DOCKER_COMPOSE) --profile kafka-test up kafka-test-producer
	@echo "âœ… Test messages sent successfully!"

# ğŸ§¹ Clean up Kafka topics (removes all non-system topics)
kafka-cleanup-topics:
	@echo "ğŸ§¹ Cleaning up Kafka topics..."
	@echo "âš ï¸  This will delete all non-system topics!"
	$(DOCKER_COMPOSE) --profile kafka-cleanup up kafka-cleanup
	@echo "âœ… Kafka topics cleaned up!"

# =============================================================================
# ğŸ“¡ ActiveMQ JMS Server Management
# =============================================================================

# ğŸš€ Start ActiveMQ JMS server with setup
activemq-start:
	@echo "Starting ActiveMQ JMS server..."
	$(DOCKER_COMPOSE) --profile activemq up -d activemq activemq-setup
	@echo "â³ Waiting for ActiveMQ to fully initialize..."
	@sleep 15
	@echo "âœ… ActiveMQ started. Web Console: http://localhost:8161/console"
	@echo "ğŸ”‘ Credentials: admin/admin"

# ğŸš€ Start ActiveMQ JMS server for development (no setup)
activemq-dev-start:
	@echo "Starting ActiveMQ JMS server (dev mode)..."
	$(DOCKER_COMPOSE) --profile activemq-dev up -d activemq
	@echo "â³ Waiting for ActiveMQ to fully initialize..."
	@sleep 15
	@echo "âœ… ActiveMQ started in dev mode."

# â›” Stop ActiveMQ JMS server
activemq-stop:
	@echo "Stopping ActiveMQ JMS server..."
	$(DOCKER_COMPOSE) stop activemq activemq-setup 2>/dev/null || true
	@echo "âœ… ActiveMQ stopped."

# ğŸ” Check ActiveMQ JMS server status and connection
activemq-status:
	@echo "ğŸ” Checking ActiveMQ status..."
	@container_status=$$(docker inspect -f '{{.State.Status}}' snaplogic-activemq 2>/dev/null || echo "not found"); \
	if [ "$$container_status" = "running" ]; then \
		echo "âœ… ActiveMQ container is running"; \
		echo "ğŸŒ Web Console: http://localhost:8161/console"; \
		echo "ğŸ“¡ JMS URL: tcp://localhost:61616"; \
		echo "ğŸ”‘ Credentials: admin/admin"; \
		echo "ğŸ§ª Testing web console connection..."; \
		if curl -s -f -u admin:admin http://localhost:8161/console/ >/dev/null 2>&1; then \
			echo "âœ… Web console is accessible"; \
		else \
			echo "âš ï¸  Web console not yet ready (may still be starting)"; \
		fi; \
	else \
		echo "âŒ ActiveMQ container is not running (status: $$container_status)"; \
		echo "ğŸ’¡ Run 'make activemq-start' to start ActiveMQ"; \
	fi

# ğŸ”§ Run ActiveMQ setup and display connection info
activemq-setup:
	@echo "ğŸ”§ Running ActiveMQ setup and displaying connection info..."
	@$(MAKE) activemq-status
	@echo ""
	@echo "ğŸ“‹ Queue Suggestions for SAP IDOC Integration:"
	@echo "   â€¢ sap.idoc.queue - Main queue for SAP IDOC messages"
	@echo "   â€¢ test.queue - Queue for testing and development"
	@echo "   â€¢ demo.queue - Queue for demonstrations"
	@echo ""
	@echo "ğŸ› ï¸  Sample JMS Connection Properties:"
	@echo "   â€¢ Broker URL: tcp://localhost:61616"
	@echo "   â€¢ Username: admin"
	@echo "   â€¢ Password: admin"
	@echo "   â€¢ Connection Factory: ConnectionFactory"
	@echo ""
	@echo "ğŸ’¡ Queues are auto-created when first accessed"
	@echo "ğŸ’¡ Use the web console to monitor queues and messages"

# ğŸ§ª Run JMS demo script (placeholder for future implementation)
run-jms-demo:
	@echo "ğŸ§ª JMS Demo Script"
	@echo "ğŸ“ This target is ready for your JMS demo implementation"
	@echo "ğŸ’¡ Consider creating: test/suite/test_data/python_helper_files/jms_demo.py"
	@echo ""
	@echo "ğŸ”§ Connection details for your demo:"
	@echo "   â€¢ JMS URL: tcp://localhost:61616"
	@echo "   â€¢ Username: admin"
	@echo "   â€¢ Password: admin"
	@echo "   â€¢ Suggested queues: sap.idoc.queue, test.queue, demo.queue"
	@echo ""
	@echo "ğŸ“š Example libraries: pyjms, stomp.py, or py4j with ActiveMQ client"
