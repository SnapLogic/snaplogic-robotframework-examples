# =============================================================================
# ðŸ”Œ Salesforce Mock API Server Management
# =============================================================================
# This file contains targets for Salesforce mock API services including
# WireMock for API mocking and JSON Server for persistent CRUD operations
# =============================================================================

.PHONY: salesforce-mock-start salesforce-mock-stop salesforce-mock-status \
        salesforce-mock-restart salesforce-mock-clean start-jsonserver stop-jsonserver \
        salesforce-test salesforce-mock-logs

# Include common configuration
include makefiles/common_services/Makefile.common

# =============================================================================
# Salesforce Mock Service Management
# =============================================================================

# ðŸš€ Start Salesforce Mock server with all components
salesforce-mock-start:
	@echo "ðŸš€ Starting Salesforce Mock API server..."
	$(DOCKER_COMPOSE) --profile salesforce-dev up -d salesforce-mock salesforce-json-server
	@echo "â³ Waiting for services to initialize..."
	@sleep 5
	@echo "âœ… Salesforce mock services started!"
	@echo ""
	@echo "ðŸŒ Available endpoints:"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "ðŸ“¡ WireMock API Mock:"
	@echo "   â€¢ Base URL: http://localhost:8089 (will show 403 - this is normal!)"
	@echo "   â€¢ OAuth Token: POST http://localhost:8089/services/oauth2/token"
	@echo "   â€¢ Query API: GET http://localhost:8089/services/data/v59.0/query"
	@echo "   â€¢ CRUD Operations: http://localhost:8089/services/data/v59.0/sobjects/Account"
	@echo "   â€¢ Admin Console: http://localhost:8089/__admin/"
	@echo "   â€¢ View Mappings: http://localhost:8089/__admin/mappings"
	@echo ""
	@echo "ðŸ’¾ JSON Server (Persistent Storage):"
	@echo "   â€¢ Base URL: http://localhost:8082"
	@echo "   â€¢ Accounts: http://localhost:8082/accounts"
	@echo "   â€¢ Contacts: http://localhost:8082/contacts"
	@echo "   â€¢ Opportunities: http://localhost:8082/opportunities"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "ðŸ”§ Configure SnapLogic Salesforce Account:"
	@echo "   â€¢ Login URL: http://localhost:8089"
	@echo "   â€¢ Username: snap-qa@snaplogic.com (or any value)"
	@echo "   â€¢ Password: any value"
	@echo ""
	@echo "ðŸ§ª Test the service:"
	@echo "   curl -X POST http://localhost:8089/services/oauth2/token -d 'grant_type=password'"

# ðŸš€ Start only JSON Server for persistent CRUD operations
start-jsonserver:
	@echo "ðŸš€ Starting Salesforce JSON Server..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	docker compose -f docker/docker-compose.salesforce-mock.yml up -d salesforce-json-server
	@echo "â³ Waiting for JSON Server to initialize..."
	@sleep 3
	@echo "âœ… JSON Server started!"
	@echo ""
	@echo "ðŸŒ Available endpoints:"
	@echo "   â€¢ From host machine: http://localhost:8082"
	@echo "   â€¢ From Docker containers: http://salesforce-json-mock"
	@echo "   â€¢ Database file: ./docker/scripts/salesforce/json-db/salesforce-db.json"
	@echo ""
	@echo "ðŸ§ª Test from your host machine:"
	@echo "   curl http://localhost:8082/accounts"
	@echo "   curl http://localhost:8082/contacts"
	@echo "   curl http://localhost:8082/opportunities"
	@echo ""
	@echo "ðŸ³ Test from Docker container (e.g., Groundplex):"
	@echo "   docker exec snaplogic-groundplex curl http://salesforce-json-mock/accounts"
	@echo ""
	@echo "ðŸ”§ SnapLogic REST Snap configuration:"
	@echo "   Service URL: http://salesforce-json-mock"
	@echo "   Resource Path: /accounts"

# â›” Stop all Salesforce Mock services
salesforce-mock-stop:
	@echo "â›” Stopping Salesforce Mock server containers..."
	$(DOCKER_COMPOSE) stop salesforce-mock salesforce-json-server || true
	@echo "ðŸ—‘ï¸ Removing Salesforce mock containers and volumes..."
	$(DOCKER_COMPOSE) rm -f -v salesforce-mock salesforce-json-server || true
	@echo "ðŸ§¹ Cleaning up Salesforce mock volumes..."
	docker volume rm $$(docker volume ls -q | grep salesforce) 2>/dev/null || true
	@echo "âœ… Salesforce mock stopped and cleaned up."

# â›” Stop only JSON Server
stop-jsonserver:
	@echo "â›” Stopping Salesforce JSON Server..."
	docker compose -f docker/docker-compose.salesforce-mock.yml stop salesforce-json-server || true
	@echo "ðŸ—‘ï¸ Removing JSON Server container..."
	docker compose -f docker/docker-compose.salesforce-mock.yml rm -f salesforce-json-server || true
	@echo "âœ… JSON Server stopped and cleaned up."

# ðŸ”„ Restart Salesforce Mock services
salesforce-mock-restart:
	@echo "ðŸ”„ Restarting Salesforce Mock server..."
	@$(MAKE) salesforce-mock-stop
	@sleep 2
	@$(MAKE) salesforce-mock-start

# ðŸ” Check Salesforce Mock services status
salesforce-mock-status:
	@bash -c '\
		echo "ðŸ” Checking Salesforce Mock status..."; \
		echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
		wiremock_status=$$(docker inspect -f "{{.State.Status}}" salesforce-api-mock 2>/dev/null || echo "not found"); \
		json_server_status=$$(docker inspect -f "{{.State.Status}}" salesforce-json-mock 2>/dev/null || echo "not found"); \
		if [ "$$wiremock_status" = "running" ]; then \
			echo "âœ… WireMock container is running"; \
			echo "   Container: salesforce-api-mock"; \
			echo "   Port: 8089"; \
		else \
			echo "âŒ WireMock container is not running (status: $$wiremock_status)"; \
		fi; \
		if [ "$$json_server_status" = "running" ]; then \
			echo "âœ… JSON Server container is running"; \
			echo "   Container: salesforce-json-mock"; \
			echo "   Port: 8082"; \
		else \
			echo "âŒ JSON Server container is not running (status: $$json_server_status)"; \
		fi; \
		echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
		if [ "$$wiremock_status" = "running" ] && [ "$$json_server_status" = "running" ]; then \
			echo "ðŸŒ Available endpoints:"; \
			echo "   â€¢ Base URL: http://localhost:8089"; \
			echo "   â€¢ Admin Console: http://localhost:8089/__admin/"; \
			echo "   â€¢ Request Journal: http://localhost:8089/__admin/requests"; \
			echo "   â€¢ JSON Server: http://localhost:8082"; \
			echo ""; \
			echo "ðŸ§ª Testing service health..."; \
			if curl -s -f http://localhost:8089/__admin/health >/dev/null 2>&1; then \
				echo "   âœ… WireMock health check passed"; \
			else \
				echo "   âš ï¸  WireMock health check failed"; \
			fi; \
			if curl -s -f -X POST http://localhost:8089/services/oauth2/token -d "grant_type=password" >/dev/null 2>&1; then \
				echo "   âœ… OAuth endpoint is accessible"; \
			else \
				echo "   âš ï¸  OAuth endpoint not responding"; \
			fi; \
			if curl -s -f http://localhost:8082/ >/dev/null 2>&1; then \
				echo "   âœ… JSON Server is accessible"; \
			else \
				echo "   âš ï¸  JSON Server not responding"; \
			fi; \
		elif [ "$$wiremock_status" = "running" ] || [ "$$json_server_status" = "running" ]; then \
			echo "âš ï¸  WARNING: Only partial services are running"; \
			echo "ðŸ’¡ Run '\''make salesforce-mock-restart'\'' to restart all services"; \
		else \
			echo "ðŸ’¡ Run '\''make salesforce-mock-start'\'' to start the mock services"; \
		fi'

# ðŸ§¹ Clean Salesforce mock data and restart
salesforce-mock-clean:
	@echo "ðŸ§¹ Cleaning Salesforce mock data..."
	@$(MAKE) salesforce-mock-stop
	@echo "ðŸ—‘ï¸ Removing all Salesforce mock volumes and data..."
	@docker volume rm $$(docker volume ls -q | grep salesforce) 2>/dev/null || true
	@rm -rf ./docker/scripts/salesforce/json-db/*.json 2>/dev/null || true
	@echo "âœ… Salesforce mock data cleaned!"

# ðŸ§ª Test Salesforce mock endpoints
salesforce-test:
	@echo "ðŸ§ª Testing Salesforce mock endpoints..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "1ï¸âƒ£ Testing OAuth endpoint..."
	@curl -s -X POST http://localhost:8089/services/oauth2/token \
		-d "grant_type=password&username=test@test.com&password=test" \
		| python3 -m json.tool 2>/dev/null || echo "   âš ï¸  OAuth endpoint not responding"
	@echo ""
	@echo "2ï¸âƒ£ Testing JSON Server accounts endpoint..."
	@curl -s http://localhost:8082/accounts | python3 -m json.tool 2>/dev/null || echo "   âš ï¸  JSON Server not responding"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "âœ… Salesforce mock tests completed!"

# ðŸ“‹ View Salesforce mock logs
salesforce-mock-logs:
	@echo "ðŸ“‹ Salesforce Mock Service Logs"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "ðŸ“¡ WireMock Logs:"
	@docker logs salesforce-api-mock --tail=20 2>/dev/null || echo "   No WireMock logs available"
	@echo ""
	@echo "ðŸ’¾ JSON Server Logs:"
	@docker logs salesforce-json-mock --tail=20 2>/dev/null || echo "   No JSON Server logs available"
