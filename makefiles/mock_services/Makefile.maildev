# =============================================================================
# ðŸ“§ Email Server (MailDev) Management
# =============================================================================
# This file contains targets for MailDev email testing server
# MailDev provides a simple way to test email sending functionality
# =============================================================================

.PHONY: email-start email-stop email-restart email-status email-clean \
        email-logs email-test email-web email-purge

# Include common configuration
include makefiles/common_services/Makefile.common

# =============================================================================
# MailDev Email Service Management
# =============================================================================

# ðŸš€ Start MailDev email testing server
email-start:
	@echo "ðŸ“§ Starting MailDev email testing server..."
	docker compose $(ENV_FILE_FLAGS) -f docker/docker-compose.email-mock.yml --profile email-mock up -d maildev
	@echo "â³ Waiting for MailDev to initialize..."
	@sleep 3
	@echo "âœ… MailDev email server started!"
	@echo ""
	@echo "ðŸŒ Service endpoints:"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "ðŸ“¬ SMTP Configuration:"
	@echo "   â€¢ SMTP Host: localhost"
	@echo "   â€¢ SMTP Port: 1025"
	@echo "   â€¢ Authentication: None required"
	@echo "   â€¢ Encryption: None"
	@echo ""
	@echo "ðŸ–¥ï¸ Web Interface:"
	@echo "   â€¢ Web UI: http://localhost:1080"
	@echo "   â€¢ Auto-refresh enabled"
	@echo "   â€¢ All emails are caught here"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "ðŸ”§ SnapLogic Email Snap configuration:"
	@echo "   â€¢ SMTP Host: localhost (or maildev-test from Groundplex)"
	@echo "   â€¢ Port: 1025"
	@echo "   â€¢ Authentication: None"
	@echo "   â€¢ Encryption: None"
	@echo ""
	@echo "ðŸ³ Docker network access:"
	@echo "   â€¢ From Groundplex: maildev-test:1025"
	@echo "   â€¢ Container name: maildev-test"

# â›” Stop MailDev email testing server
email-stop:
	@echo "â›” Stopping MailDev email server..."
	docker compose $(ENV_FILE_FLAGS) -f docker/docker-compose.email-mock.yml stop maildev || true
	@echo "ðŸ—‘ï¸ Removing MailDev container and volumes..."
	docker compose $(ENV_FILE_FLAGS) -f docker/docker-compose.email-mock.yml rm -f -v maildev || true
	@echo "âœ… MailDev email server stopped and cleaned up."

# ðŸ”„ Restart MailDev email testing server
email-restart:
	@echo "ðŸ”„ Restarting MailDev email server..."
	@$(MAKE) email-stop
	@sleep 2
	@$(MAKE) email-start
	@echo "âœ… MailDev email server restarted successfully!"

# ðŸ” Check MailDev email server status
email-status:
	@echo "ðŸ” Checking MailDev email server status..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@container_status=$$(docker inspect -f '{{.State.Status}}' maildev-test 2>/dev/null || echo "not found"); \
	if [ "$$container_status" = "running" ]; then \
		echo "âœ… MailDev container is running"; \
		echo "   Container: maildev-test"; \
		echo "   SMTP Port: 1025"; \
		echo "   Web UI Port: 1080"; \
		echo ""; \
		echo "ðŸ§ª Testing service health..."; \
		if curl -s -f http://localhost:1080/ >/dev/null 2>&1; then \
			echo "   âœ… Web UI is accessible at http://localhost:1080"; \
			email_count=$$(curl -s http://localhost:1080/email | python3 -c "import sys, json; data=json.load(sys.stdin); print(len(data))" 2>/dev/null || echo "0"); \
			echo "   ðŸ“¬ Emails in inbox: $$email_count"; \
		else \
			echo "   âš ï¸  Web UI not responding (may still be starting)"; \
		fi; \
		echo ""; \
		echo "ðŸ“Š Container resource usage:"; \
		docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" maildev-test 2>/dev/null || true; \
		echo ""; \
		echo "ðŸŒ Network connectivity:"; \
		docker inspect maildev-test --format '{{range $k, $v := .NetworkSettings.Networks}}   Network: {{$k}} (IP: {{$v.IPAddress}}){{end}}' 2>/dev/null || true; \
	else \
		echo "âŒ MailDev container is not running (status: $$container_status)"; \
		echo "ðŸ’¡ Run 'make email-start' to start the email server"; \
	fi

# ðŸ—‘ï¸ Purge all emails from MailDev inbox
email-purge:
	@echo "ðŸ—‘ï¸ Purging all emails from MailDev inbox..."
	@echo "ðŸ” Checking MailDev accessibility at http://localhost:1080..."
	@if curl -s -f http://localhost:1080/ >/dev/null 2>&1; then \
		echo "âœ… MailDev is accessible"; \
		response=$$(curl -s -o /dev/null -w "%{http_code}" -X DELETE http://localhost:1080/email/all); \
		if [ "$$response" = "200" ]; then \
			echo "âœ… All emails have been purged from MailDev"; \
			email_count=$$(curl -s http://localhost:1080/email | python3 -c "import sys, json; data=json.load(sys.stdin); print(len(data))" 2>/dev/null || echo "0"); \
			echo "ðŸ“¬ Inbox is now empty ($$email_count emails)"; \
		else \
			echo "âš ï¸  Failed to purge emails (HTTP status: $$response)"; \
			echo "ðŸ’¡ Try accessing http://localhost:1080 in your browser"; \
		fi; \
	else \
		echo "âŒ Cannot connect to MailDev at http://localhost:1080"; \
		echo "ðŸ’¡ Checking for MailDev containers..."; \
		docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -i mail || echo "  No mail-related containers found"; \
		echo ""; \
		echo "ðŸ’¡ To start MailDev, run: make email-start"; \
	fi

# ðŸ§¹ Clean all email server data and restart
email-clean:
	@echo "ðŸ§¹ Cleaning and restarting MailDev email server..."
	@$(MAKE) email-stop
	@echo "ðŸ—‘ï¸ Removing any cached email data..."
	@docker volume prune -f 2>/dev/null || true
	@sleep 2
	@$(MAKE) email-start
	@echo "âœ… MailDev email server started with clean state!"
	@echo "ðŸ“¬ All previous emails have been cleared."

# ðŸ“‹ View MailDev logs
email-logs:
	@echo "ðŸ“‹ MailDev Email Server Logs"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@docker logs maildev-test --tail=50 2>/dev/null || echo "âŒ No logs available. Is MailDev running?"

# ðŸ§ª Send test email to MailDev
email-test:
	@echo "ðŸ§ª Sending test email to MailDev..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@if command -v python3 >/dev/null 2>&1; then \
		echo "ðŸ“¤ Sending test email via Python..."; \
		python3 -c "import smtplib; from email.mime.text import MIMEText; from datetime import datetime; \
		msg = MIMEText('This is a test email sent to MailDev at ' + str(datetime.now())); \
		msg['Subject'] = 'MailDev Test Email'; \
		msg['From'] = 'test@snaplogic.com'; \
		msg['To'] = 'recipient@example.com'; \
		s = smtplib.SMTP('localhost', 1025); \
		s.send_message(msg); \
		s.quit(); \
		print('âœ… Test email sent successfully!')"; \
		echo ""; \
		echo "ðŸ“¬ View the email at: http://localhost:1080"; \
	else \
		echo "âŒ Python3 not found. Using telnet method..."; \
		echo "ðŸ’¡ Install Python3 for easier email testing"; \
		echo ""; \
		echo "Manual test command:"; \
		echo "telnet localhost 1025"; \
		echo "HELO localhost"; \
		echo "MAIL FROM: test@example.com"; \
		echo "RCPT TO: recipient@example.com"; \
		echo "DATA"; \
		echo "Subject: Test Email"; \
		echo "This is a test email."; \
		echo "."; \
		echo "QUIT"; \
	fi

# ðŸŒ Open MailDev web interface
email-web:
	@echo "ðŸŒ Opening MailDev web interface..."
	@if command -v open >/dev/null 2>&1; then \
		open http://localhost:1080; \
		echo "âœ… Opened http://localhost:1080 in your browser"; \
	elif command -v xdg-open >/dev/null 2>&1; then \
		xdg-open http://localhost:1080; \
		echo "âœ… Opened http://localhost:1080 in your browser"; \
	else \
		echo "ðŸ“Œ Please open http://localhost:1080 in your browser"; \
	fi
