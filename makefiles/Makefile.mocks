# =============================================================================
# Mock Services Management
# =============================================================================
# This file contains targets for managing mock services like Salesforce, 
# MinIO (S3), Email server, and other mock/testing services
# =============================================================================

.PHONY: start-s3-emulator stop-s3-emulator run-s3-demo \
        salesforce-mock-start salesforce-mock-stop salesforce-mock-status salesforce-mock-restart \
        start-jsonserver stop-jsonserver \
        email-start email-stop email-restart email-status email-clean

# Include common configuration
include makefiles/Makefile.common

# =============================================================================
# â˜ï¸ MinIO S3-Compatible Storage Emulator
# =============================================================================
start-s3-emulator:
	@echo "Starting Minio..."
	$(DOCKER_COMPOSE) --profile minio-dev up -d minio

stop-s3-emulator:
	@echo "Stopping Minio..."
	$(DOCKER_COMPOSE) stop minio

run-s3-demo:
	@echo "Running minio_demo.py script..."
	python3 test/suite/test_data/python_helper_files/minio_demo.py \
		--endpoint http://localhost:9010 \
		--access-key minioadmin \
		--secret-key minioadmin \
		--bucket demo-bucket2

# =============================================================================
# ðŸ”Œ Salesforce Mock API Server Management
# =============================================================================

# ðŸš€ Start JSON Server for Salesforce persistent CRUD operations
start-jsonserver:
	@echo "ðŸš€ Starting Salesforce JSON Server..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	docker compose -f docker/docker-compose.salesforce-mock.yml up -d salesforce-json-server
	@echo "â³ Waiting for JSON Server to initialize..."
	@sleep 3
	@echo "âœ… JSON Server started!"
	@echo ""
	@echo "ðŸŒ Available endpoints:"
	@echo "   â€¢ From host machine: http://localhost:8082"
	@echo "   â€¢ From Docker containers: http://salesforce-json-mock"
	@echo "   â€¢ Database file: ./docker/scripts/salesforce/json-db/salesforce-db.json"
	@echo ""
	@echo "ðŸ§ª Test from your host machine:"
	@echo "   curl http://localhost:8082/accounts"
	@echo "   curl http://localhost:8082/contacts"
	@echo "   curl http://localhost:8082/opportunities"
	@echo ""
	@echo "ðŸ³ Test from Docker container (e.g., Groundplex):"
	@echo "   docker exec snaplogic-groundplex curl http://salesforce-json-mock/accounts"
	@echo ""
	@echo "ðŸ”§ SnapLogic REST Snap configuration:"
	@echo "   Service URL: http://salesforce-json-mock"
	@echo "   Resource Path: /accounts"

# â›” Stop JSON Server
stop-jsonserver:
	@echo "â›” Stopping Salesforce JSON Server..."
	docker compose -f docker/docker-compose.salesforce-mock.yml stop salesforce-json-server || true
	@echo "ðŸ—‘ï¸ Removing JSON Server container..."
	docker compose -f docker/docker-compose.salesforce-mock.yml rm -f salesforce-json-server || true
	@echo "âœ… JSON Server stopped and cleaned up."

# ðŸš€ Start Salesforce Mock server for API mocking
salesforce-mock-start:
	@echo "ðŸš€ Starting Salesforce Mock API server..."
	$(DOCKER_COMPOSE) --profile salesforce-dev up -d salesforce-mock salesforce-json-server
	@echo "â³ Waiting for WireMock to initialize..."
	@sleep 5
	@echo "âœ… Salesforce mock service started!"
	@echo ""
	@echo "ðŸŒ Available endpoints:"
	@echo "   â€¢ Base URL: http://localhost:8089 (will show 403 - this is normal!)"
	@echo "   â€¢ OAuth Token: POST http://localhost:8089/services/oauth2/token"
	@echo "   â€¢ Query API: GET http://localhost:8089/services/data/v59.0/query"
	@echo "   â€¢ CRUD Operations: http://localhost:8089/services/data/v59.0/sobjects/Account"
	@echo "   â€¢ Admin Console: http://localhost:8089/__admin/"
	@echo "   â€¢ View Mappings: http://localhost:8089/__admin/mappings"
	@echo ""
	@echo "ðŸ”§ Configure SnapLogic Salesforce Account:"
	@echo "   â€¢ Login URL: http://localhost:8089"
	@echo "   â€¢ Username: snap-qa@snaplogic.com (or any value)"
	@echo "   â€¢ Password: any value"
	@echo ""
	@echo "ðŸ§ª Test the service:"
	@echo "   curl -X POST http://localhost:8089/services/oauth2/token -d 'grant_type=password'"

# â›” Stop Salesforce Mock server and clean up volumes
salesforce-mock-stop:
	@echo "â›” Stopping Salesforce Mock server containers..."
	$(DOCKER_COMPOSE) stop salesforce-mock salesforce-json-server || true
	@echo "Removing Salesforce mock containers and volumes..."
	$(DOCKER_COMPOSE) rm -f -v salesforce-mock salesforce-json-server || true
	@echo "Cleaning up Salesforce mock volumes..."
	docker volume rm $(docker volume ls -q | grep salesforce) 2>/dev/null || true
	@echo "âœ… Salesforce mock stopped and cleaned up."

# ðŸ” Check Salesforce Mock server status
salesforce-mock-status:
	@bash -c '\
		echo "ðŸ” Checking Salesforce Mock status..."; \
		echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
		wiremock_status=$$(docker inspect -f "{{.State.Status}}" salesforce-api-mock 2>/dev/null || echo "not found"); \
		json_server_status=$$(docker inspect -f "{{.State.Status}}" salesforce-json-mock 2>/dev/null || echo "not found"); \
		if [ "$$wiremock_status" = "running" ]; then \
			echo "âœ… WireMock container is running"; \
			echo "   Container: salesforce-api-mock"; \
			echo "   Port: 8089"; \
		else \
			echo "âŒ WireMock container is not running (status: $$wiremock_status)"; \
		fi; \
		if [ "$$json_server_status" = "running" ]; then \
			echo "âœ… JSON Server container is running"; \
			echo "   Container: salesforce-json-mock"; \
			echo "   Port: 8082"; \
		else \
			echo "âŒ JSON Server container is not running (status: $$json_server_status)"; \
		fi; \
		echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
		if [ "$$wiremock_status" = "running" ] && [ "$$json_server_status" = "running" ]; then \
			echo "ðŸŒ Available endpoints:"; \
			echo "   â€¢ Base URL: http://localhost:8089"; \
			echo "   â€¢ Admin Console: http://localhost:8089/__admin/"; \
			echo "   â€¢ Request Journal: http://localhost:8089/__admin/requests"; \
			echo "   â€¢ JSON Server: http://localhost:8082"; \
			echo ""; \
			echo "ðŸ§ª Testing service health..."; \
			if curl -s -f http://localhost:8089/__admin/health >/dev/null 2>&1; then \
				echo "   âœ… WireMock health check passed"; \
			else \
				echo "   âš ï¸  WireMock health check failed"; \
			fi; \
			if curl -s -f -X POST http://localhost:8089/services/oauth2/token -d "grant_type=password" >/dev/null 2>&1; then \
				echo "   âœ… OAuth endpoint is accessible"; \
			else \
				echo "   âš ï¸  OAuth endpoint not responding"; \
			fi; \
			if curl -s -f http://localhost:8082/ >/dev/null 2>&1; then \
				echo "   âœ… JSON Server is accessible"; \
			else \
				echo "   âš ï¸  JSON Server not responding"; \
			fi; \
		elif [ "$$wiremock_status" = "running" ] || [ "$$json_server_status" = "running" ]; then \
			echo "âš ï¸  WARNING: Only partial services are running"; \
			echo "ðŸ’¡ Run '\''make salesforce-mock-restart'\'' to restart all services"; \
		else \
			echo "ðŸ’¡ Run '\''make salesforce-mock-start'\'' to start the mock services"; \
		fi'

# ðŸ”„ Restart Salesforce Mock server
salesforce-mock-restart:
	@echo "ðŸ”„ Restarting Salesforce Mock server..."
	@$(MAKE) salesforce-mock-stop
	@sleep 2
	@$(MAKE) salesforce-mock-start

# =============================================================================
# ðŸ“§ Email Server (MailDev) Management
# =============================================================================

# ðŸš€ Start MailDev email testing server
email-start:
	@echo "ðŸ“§ Starting MailDev email testing server..."
	$(DOCKER_COMPOSE_EMAIL) --profile email-mock up -d maildev
	@echo "â³ Waiting for MailDev to initialize..."
	@sleep 3
	@echo "âœ… MailDev email server started!"
	@echo ""
	@echo "ðŸŒ Service endpoints:"
	@echo "   â€¢ SMTP Server: localhost:1025 (no auth required)"
	@echo "   â€¢ Web UI: http://localhost:1080"
	@echo ""
	@echo "ðŸ”§ SnapLogic Email Snap configuration:"
	@echo "   â€¢ SMTP Host: localhost (or maildev-test from Groundplex)"
	@echo "   â€¢ Port: 1025"
	@echo "   â€¢ Authentication: None"
	@echo "   â€¢ Encryption: None"

# â›” Stop MailDev email testing server
email-stop:
	@echo "â›” Stopping MailDev email server..."
	$(DOCKER_COMPOSE_EMAIL) stop maildev || true
	@echo "ðŸ—‘ï¸ Removing MailDev container and volumes..."
	$(DOCKER_COMPOSE_EMAIL) rm -f -v maildev || true
	@echo "âœ… MailDev email server stopped and cleaned up."

# ðŸ”„ Restart MailDev email testing server
email-restart:
	@echo "ðŸ”„ Restarting MailDev email server..."
	@$(MAKE) email-stop
	@sleep 2
	@$(MAKE) email-start
	@echo "âœ… MailDev email server restarted successfully!"

# ðŸ” Check MailDev email server status
email-status:
	@echo "ðŸ” Checking MailDev email server status..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@container_status=$(docker inspect -f '{{.State.Status}}' maildev-test 2>/dev/null || echo "not found"); \
	if [ "$container_status" = "running" ]; then \
		echo "âœ… MailDev container is running"; \
		echo "   Container: maildev-test"; \
		echo "   SMTP Port: 1025"; \
		echo "   Web UI Port: 1080"; \
		echo ""; \
		echo "ðŸ§ª Testing service health..."; \
		if curl -s -f http://localhost:1080/ >/dev/null 2>&1; then \
			echo "   âœ… Web UI is accessible at http://localhost:1080"; \
		else \
			echo "   âš ï¸  Web UI not responding (may still be starting)"; \
		fi; \
		echo ""; \
		echo "ðŸ“Š Container resource usage:"; \
		docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" maildev-test 2>/dev/null || true; \
	else \
		echo "âŒ MailDev container is not running (status: $container_status)"; \
		echo "ðŸ’¡ Run 'make email-start' to start the email server"; \
	fi

# ðŸ§¹ Clean all email server data and restart
email-clean:
	@echo "ðŸ§¹ Cleaning and restarting MailDev email server..."
	@$(MAKE) email-stop
	@echo "ðŸ—‘ï¸ Removing any cached email data..."
	@docker volume prune -f 2>/dev/null || true
	@sleep 2
	@$(MAKE) email-start
	@echo "âœ… MailDev email server started with clean state!"
